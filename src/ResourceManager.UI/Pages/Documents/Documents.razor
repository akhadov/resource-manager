@page "/documents"
@using ResourceManager.Application.Documents.CreateDocument
@using ResourceManager.Application.DocumentHistories.GetDocumentHistory
@using ResourceManager.Application.Documents.GetDocuments
@using ResourceManager.UI.Services.Interfaces
@inject IDialogService DialogService
@inject IDocumentService _documentService

<MudText Typo="Typo.h3">Documents</MudText>

<!-- Add Document Button (top right) -->
<MudGrid>
    <MudItem xs="10">
        <!-- Placeholder for title or filters if needed -->
    </MudItem>
    <MudItem xs="2">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="AddDocumentDialog">Add Document</MudButton>
    </MudItem>
</MudGrid>

<!-- Documents Table -->
<MudTable Items="_documents" Hover="true" Bordered="true" Striped="true">
    <ColGroup>
        <col style="width:300px;" /> <!-- Username -->
        <col /> <!-- Title -->
        <col style="width:100px;" /> <!-- Status -->
        <col style="width:200px;" /> <!-- CreatedAt -->
        <col style="width:200px;" /> <!-- UpdatedAt -->
        <col style="width:150px;" /> <!-- Actions -->
    </ColGroup>
    <HeaderContent>
        <MudTh>Username</MudTh>
        <MudTh>Title</MudTh>
        <MudTh>Content</MudTh>
        <MudTh>Status</MudTh>
        <MudTh>CreatedAt</MudTh>
        <MudTh>UpdatedAt</MudTh>
        <MudTh>CurrentLevel</MudTh>
        <MudTh>NextLevel</MudTh>
        <MudTh>Actions</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Username">@context.Username</MudTd>
        <MudTd DataLabel="Title">@context.Title</MudTd>
        <MudTd DataLabel="Content">@context.Content</MudTd>
        <MudTd DataLabel="Status">@context.Status</MudTd>
        <MudTd DataLabel="CreatedAt">@context.CreatedAt</MudTd>
        <MudTd DataLabel="UpdatedAt">@context.UpdatedAt</MudTd>
        <MudTd DataLabel="CurrentLevel">@context.CurrentLevel</MudTd>
        <MudTd DataLabel="NextLevel">@context.NextLevel</MudTd>
        <MudTd>
            <!-- Update Icon Button -->
            <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" OnClick="@(async () => await UpdateDocumentDialog(context.Id, context.Title, context.Content))" Color="Color.Primary" />

            <!-- Delete Icon Button -->
            <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" OnClick="@(async () => await DeleteDocument(context.Id))" Color="Color.Error" />

            <!-- History Icon Button -->
            <MudIconButton Icon="@Icons.Material.Filled.History" Size="Size.Small" OnClick="@(async () => await ShowHistories(context.Id))" Color="Color.Default" />
        </MudTd>
    </RowTemplate>

    <!-- Display History under the selected document -->
    <ChildRowContent>
        @if (selectedDocumentId == context.Id && _histories != null)
        {
            <MudTr>
                <MudTd ColSpan="9">
                    <MudTable Items="_histories" Hover="true" Bordered="true">
                        <HeaderContent>
                            <MudTh>Name</MudTh>
                            <MudTh>Action</MudTh>
                            <MudTh>Type</MudTh>
                            <MudTh>CreatedAt</MudTh>
                        </HeaderContent>
                        <RowTemplate Context="historyContext">
                            <MudTd DataLabel="Name">@historyContext.Name</MudTd>
                            <MudTd DataLabel="Action">@historyContext.Action</MudTd>
                            <MudTd DataLabel="Type">@historyContext.Type</MudTd>
                            <MudTd DataLabel="CreatedAt">@historyContext.CreatedAt</MudTd>
                        </RowTemplate>
                    </MudTable>
                </MudTd>
            </MudTr>
        }
    </ChildRowContent>
</MudTable>

@code {
    private IEnumerable<DocumentResponse>? _documents { get; set; } = new List<DocumentResponse>();
    private IEnumerable<HistoryResponse>? _histories { get; set; } = new List<HistoryResponse>();

    private Guid? selectedDocumentId;

    protected override async Task OnInitializedAsync()
    {
        await LoadDocuments();
    }

    private async Task LoadDocuments()
    {
        _documents = await _documentService.GetDocuments();
    }

    // Show the add document dialog
    private Task AddDocumentDialog()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true };
        return DialogService.ShowAsync<AddDocumentDialog>("Add Document", options);
    }

    // Show the update document dialog
    private async Task UpdateDocumentDialog(Guid documentId, string title, string content)
    {
        var parameters = new DialogParameters
        {
            { "DocumentId", documentId },
            { "Title", title },
            { "Content", content }
        };

        var options = new DialogOptions { CloseOnEscapeKey = true };
        var dialog = DialogService.Show<UpdateDocumentDialog>("Update Document", parameters, options);

        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadDocuments();
        }
    }

    // Show the history for a selected document
    private async Task ShowHistories(Guid documentId)
    {
        if (selectedDocumentId == documentId)
        {
            // Hide history if same document is clicked again
            selectedDocumentId = null;
            _histories = null;
        }
        else
        {
            selectedDocumentId = documentId;
            _histories = await _documentService.GetHistories(documentId);
        }
    }

    // Delete the document
    private async Task DeleteDocument(Guid documentId)
    {
        var confirmed = await DialogService.ShowMessageBox(
            "Delete Document",
            "Are you sure you want to delete this document?",
            yesText: "Delete", cancelText: "Cancel");

        if (confirmed == true)
        {
            var success = await _documentService.DeleteDocument(documentId);
            if (success)
            {
                await LoadDocuments();
            }
            else
            {
                // Handle failure case
            }
        }
    }
}
