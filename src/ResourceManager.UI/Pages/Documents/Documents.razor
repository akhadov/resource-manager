@page "/documents"
@using ResourceManager.Application.Documents.GetDocuments
@using ResourceManager.Application.DocumentHistories.GetDocumentHistory
@using ResourceManager.UI.Services.Interfaces
@inject IDocumentService _documentService

<MudText Typo="Typo.h3">Documents</MudText>

<MudTable Items="_documents" Hover="true" Bordered="true" Striped="true">
    <ColGroup>
        <col style="width:100px;" /> <!-- Document ID -->
        <col style="width:300px;" /> <!-- Creator ID -->
        <col style="width:300px;" /> <!-- Title -->
        <col /> <!-- Content -->
        <col style="width:100px;" /> <!-- Status -->
        <col style="width:200px;" /> <!-- CreatedAt -->
        <col style="width:200px;" /> <!-- UpdatedAt -->
        <col style="width:150px;" /> <!-- Actions -->
    </ColGroup>
    <HeaderContent>
        <MudTh>Id</MudTh>
        <MudTh>CreatorId</MudTh>
        <MudTh>Username</MudTh>
        <MudTh>Title</MudTh>
        <MudTh>Content</MudTh>
        <MudTh>Status</MudTh>
        <MudTh>CreatedAt</MudTh>
        <MudTh>UpdatedAt</MudTh>
        <MudTh>Actions</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Id">@context.Id</MudTd> <!-- Document ID comes first -->
        <MudTd DataLabel="CreatorId">@context.CreatorId</MudTd>
        <MudTd DataLabel="Username">@context.Username</MudTd>
        <MudTd DataLabel="Title">@context.Title</MudTd>
        <MudTd DataLabel="Content">@context.Content</MudTd>
        <MudTd DataLabel="Status">@context.Status</MudTd>
        <MudTd DataLabel="CreatedAt">@context.CreatedAt</MudTd>
        <MudTd DataLabel="UpdatedAt">@context.UpdatedAt</MudTd>
        <MudTd>
            <MudButton Variant="Variant.Outlined" Size="Size.Small" OnClick="@(async () => await ShowHistories(context.Id))">
                @(selectedDocumentId == context.Id ? "Hide" : "Show") History
            </MudButton>
        </MudTd> <!-- Action button comes after Document ID and other fields -->
    </RowTemplate>
    <ChildRowContent>
        @if (selectedDocumentId == context.Id)
        {
            <MudTr>
                <td colspan="8">
                    <MudCard Elevation="0">
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.body1">History Details for Document <strong>@context.Title</strong></MudText>
                            </CardHeaderContent>
                        </MudCardHeader>
                        <MudCardContent Class="pa-0">
                            <MudTable Items="_histories" Hover="true" Breakpoint="Breakpoint.Sm" Elevation="0">
                                <ColGroup>
                                    <col />
                                    <col />
                                    <col style="width:200px;" />
                                </ColGroup>
                                <HeaderContent>
                                    <MudTh>DocumentId</MudTh>
                                    <MudTh>UserId</MudTh>
                                    <MudTh>Name</MudTh>
                                    <MudTh>Action</MudTh>
                                    <MudTh>Type</MudTh>
                                    <MudTh>CreatedAt</MudTh>
                                </HeaderContent>
                                <RowTemplate Context="historyContext">
                                    <MudTd DataLabel="DocumentId">@historyContext.DocumentId</MudTd>
                                    <MudTd DataLabel="UserId">@historyContext.UserId</MudTd>
                                    <MudTd DataLabel="Name">@historyContext.Name</MudTd>
                                    <MudTd DataLabel="Action">@historyContext.Action</MudTd>
                                    <MudTd DataLabel="Type">@historyContext.Type</MudTd>
                                    <MudTd DataLabel="CreatedAt">@historyContext.CreatedAt</MudTd>
                                </RowTemplate>
                            </MudTable>
                        </MudCardContent>
                    </MudCard>
                </td>
            </MudTr>
        }
    </ChildRowContent>
</MudTable>

@code
{
    private IEnumerable<DocumentResponse>? _documents { get; set; } = new List<DocumentResponse>();
    private IEnumerable<HistoryResponse>? _histories { get; set; } = new List<HistoryResponse>();
    private Guid? selectedDocumentId;

    protected override async Task OnInitializedAsync()
    {
        var documents = await _documentService.GetDocuments();
        if (documents?.Count != 0)
        {
            _documents = documents;
        }
    }

    private async Task ShowHistories(Guid documentId)
    {
        if (selectedDocumentId == documentId)
        {
            // Hide details if the same document is clicked again
            selectedDocumentId = null;
            _histories = null;
        }
        else
        {
            // Show details for the selected document
            selectedDocumentId = documentId;
            _histories = await _documentService.GetHistories(documentId);
        }
    }
}
